@page
@model DashboardModel
@{
    ViewData["Title"] = "Dashboard";
}

<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-speedometer2" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5V6a.5.5 0 0 1-1 0V4.5A.5.5 0 0 1 8 4M3.732 5.732a.5.5 0 0 1 .707 0l.915.914a.5.5 0 1 1-.708.708l-.914-.915a.5.5 0 0 1 0-.707M2 10a.5.5 0 0 1 .5-.5h1.586a.5.5 0 0 1 0 1H2.5A.5.5 0 0 1 2 10m9.5 0a.5.5 0 0 1 .5-.5h1.5a.5.5 0 0 1 0 1H12a.5.5 0 0 1-.5-.5m.754-4.246a.39.39 0 0 0-.527-.02L7.547 9.31a.91.91 0 1 0 1.302 1.258l3.434-4.297a.39.39 0 0 0-.029-.518z"/>
                <path fill-rule="evenodd" d="M0 10a8 8 0 1 1 15.547 2.661c-.442 1.253-1.845 1.602-2.932 1.25C11.309 13.488 9.475 13 8 13c-1.474 0-3.31.488-4.615.911-1.087.352-2.49.003-2.932-1.25A8 8 0 0 1 0 10m8-7a7 7 0 0 0-6.603 9.329c.203.575.923.876 1.68.63C4.397 12.533 6.358 12 8 12s3.604.532 4.923.96c.757.245 1.477-.056 1.68-.631A7 7 0 0 0 8 3"/>
            </svg>
            Token Dashboard
        </h1>
        <p class="lead">View and inspect your authentication tokens and claims</p>
    </div>
</div>

<div class="info-box">
    <strong>‚ÑπÔ∏è About Tokens:</strong> When you authenticate with Entra External ID, you receive two types of tokens:
    <ul class="mb-0 mt-2">
        <li><strong>ID Token:</strong> Contains information about you (identity claims)</li>
        <li><strong>Access Token:</strong> Used to access protected resources like Microsoft Graph</li>
        <li><strong>Refresh Token:</strong> Long-lived credential used to obtain new access tokens</li>
    </ul>
</div>

<!-- ID Token Section -->
<div class="token-container">
    <h3 class="mb-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-person-badge" viewBox="0 0 16 16">
            <path d="M6.5 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1zM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
            <path d="M4.5 0A2.5 2.5 0 0 0 2 2.5V14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2.5A2.5 2.5 0 0 0 11.5 0zM3 2.5A1.5 1.5 0 0 1 4.5 1h7A1.5 1.5 0 0 1 13 2.5v10.795a4.2 4.2 0 0 0-.776-.492C11.392 12.387 10.063 12 8 12s-3.392.387-4.224.803a4.2 4.2 0 0 0-.776.492z"/>
        </svg>
        ID Token Claims
        @if (Model.IdTokenExpiration.HasValue)
        {
            <span class="badge bg-info float-end">
                Expires: @Model.IdTokenExpiration.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
            </span>
        }
    </h3>

    @if (Model.IdTokenClaims.Any())
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover claim-table">
                <thead>
                    <tr>
                        <th>Claim Type</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var claim in Model.IdTokenClaims.OrderBy(c => c.Type))
                    {
                        <tr>
                            <td><code>@claim.Type</code></td>
                            <td>@claim.Value</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!string.IsNullOrEmpty(Model.RawIdToken))
        {
            <div class="mt-3">
                <h5>Raw ID Token (JWT)
                    <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('idToken')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                            <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                            <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
                        </svg>
                        Copy
                    </button>
                </h5>
                <div class="token-raw" id="idToken">@Model.RawIdToken</div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-warning">No ID token claims found.</div>
    }
</div>

<!-- Access Token Section -->
<div class="token-container">
    <h3 class="mb-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-key-fill" viewBox="0 0 16 16">
            <path d="M3.5 11.5a3.5 3.5 0 1 1 3.163-5H14L15.5 8 14 9.5l-1-1-1 1-1-1-1 1zm-.5.5a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9"/>
        </svg>
        Access Token Claims
        @if (Model.AccessTokenExpiration.HasValue)
        {
            <span class="badge bg-success float-end">
                Expires: @Model.AccessTokenExpiration.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
            </span>
        }
    </h3>

    @if (Model.AccessTokenClaims.Any())
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover claim-table">
                <thead>
                    <tr>
                        <th>Claim Type</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var claim in Model.AccessTokenClaims.OrderBy(c => c.Type))
                    {
                        <tr>
                            <td><code>@claim.Type</code></td>
                            <td>@claim.Value</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!string.IsNullOrEmpty(Model.RawAccessToken))
        {
            <div class="mt-3">
                <h5>Raw Access Token (JWT)
                    <button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copyToClipboard('accessToken')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                            <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/>
                            <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/>
                        </svg>
                        Copy
                    </button>
                </h5>
                <div class="token-raw" id="accessToken">@Model.RawAccessToken</div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è No Access Token Available</strong>
            <p class="mb-0">An access token could not be acquired. This might happen if consent hasn't been granted for the required scopes.</p>
        </div>
    }
</div>

<!-- Refresh Token Section -->
<div class="token-container">
    <h3 class="mb-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16">
            <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41m-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9"/>
            <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5 5 0 0 0 8 3M3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9z"/>
        </svg>
        Refresh Token
        @if (Model.RefreshTokenManagedByMsal)
        {
            <span class="badge bg-success float-end">Managed by MSAL</span>
        }
    </h3>

    @if (Model.RefreshTokenManagedByMsal)
    {
        <div class="alert alert-info">
            <strong>üîê About Refresh Tokens:</strong>
            <p class="mb-2">
                Refresh tokens are long-lived credentials used to obtain new access tokens without requiring re-authentication. 
                When you sign in with the <code>offline_access</code> scope, Entra External ID issues a refresh token that is 
                securely managed by <strong>MSAL (Microsoft Authentication Library)</strong>.
            </p>
            <p class="mb-0">
                In this application, MSAL automatically uses the refresh token to renew your access token when it expires, 
                providing a seamless authentication experience.
            </p>
        </div>

        <div class="alert alert-secondary">
            <h5 class="alert-heading">üîí Token Security & Management</h5>
            <p class="mb-2">
                <strong>Why refresh tokens are not displayed:</strong>
            </p>
            <ul class="mb-2">
                <li>When using <code>Microsoft.Identity.Web</code> with <code>EnableTokenAcquisitionToCallDownstreamApi()</code>, 
                    refresh tokens are stored in MSAL's internal token cache, not in authentication properties</li>
                <li>This design provides better security by preventing accidental exposure of refresh tokens</li>
                <li>MSAL handles automatic token refresh transparently without requiring application code to manage refresh tokens</li>
            </ul>
            <p class="mb-0">
                <strong>Note:</strong> The refresh token is actively being used by MSAL to keep your session alive and automatically 
                renew access tokens as needed.
            </p>
        </div>

        <div class="alert alert-warning">
            <h5 class="alert-heading">‚ÑπÔ∏è Why Refresh Tokens Cannot Be Decoded</h5>
            <p class="mb-2">
                Unlike ID tokens and access tokens (which are JWTs), <strong>refresh tokens are opaque strings</strong>:
            </p>
            <ul class="mb-0">
                <li><strong>Not JWTs:</strong> Refresh tokens are not JSON Web Tokens, so they cannot be decoded at <a href="https://jwt.ms" target="_blank">jwt.ms</a> or <a href="https://jwt.io" target="_blank">jwt.io</a></li>
                <li><strong>Server-side validation:</strong> Only the authorization server (Entra External ID) can validate and use refresh tokens</li>
                <li><strong>No readable expiration:</strong> The lifetime and expiration are managed server-side and not embedded in the token itself</li>
                <li><strong>Highly sensitive:</strong> Refresh tokens provide long-term access and are intentionally designed to be opaque for security reasons</li>
                <li><strong>Token rotation:</strong> Some implementations may issue a new refresh token each time it's used (rolling refresh tokens)</li>
            </ul>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è No Refresh Token Active</strong>
            <p class="mb-0">User is not currently authenticated, or the refresh token is not available in the MSAL cache.</p>
        </div>
    }
</div>

<div class="alert alert-info mt-4">
    <h5 class="alert-heading">üí° Tip: Decode JWT Tokens</h5>
    <p class="mb-0">
        You can decode and inspect these JWT tokens at 
        <a href="https://jwt.ms" target="_blank" class="alert-link">jwt.ms</a> or 
        <a href="https://jwt.io" target="_blank" class="alert-link">jwt.io</a>
    </p>
</div>

@section Scripts {
    <script>
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(function() {
                alert('Token copied to clipboard!');
            }, function(err) {
                console.error('Could not copy text: ', err);
            });
        }
    </script>
}
